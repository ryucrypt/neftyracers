<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="96x96" href="res/favi.png">
    <title>NeftyGadgets Races</title>
    <meta property="og:title" content="NeftyGadgets Races">
    <meta property="og:image" content="https://ryucrypt.github.io/neftyracers/res/favi.png">
    <meta property="og:description" content="Stake your NeftyGadgets racers.">
    <meta property="og:type" content="website">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .nft-card {
            object-fit: contain;
            height: 10rem;
            width: 10rem;
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TKRGTCTL23"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-TKRGTCTL23');
    </script>
</head>
<body>
    <div class="container">
        <div class="modal fade" id="login" data-bs-keyboard="false" tabindex="-1" aria-labelledby="loginLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="loginLabel">Select wallet</h1>
                    </div>
                    <div class="modal-body">
                        <div class="container">
                            <div class="row">
                                <div id="login_msg" class="alert alert-danger visually-hidden mb-3" role="alert"></div>
                            </div>
                            <div class="row mb-3">
                                <button class="btn" style="color:white;background-color:rgb(133, 73, 182)" onclick="login('cloud');"><img src="res/mycloudwallet.svg" class="float-start" height="24">Cloud Wallet</button>
                            </div>
                            <div class="row mb-3">
                                <button class="btn" style="color:white;background-color:rgb(54, 80, 162)" onclick="login('anchor');"><img src="res/anchor.svg" class="float-start" height="24">Anchor</button>
                            </div>
                            <div class="row mb-3">
                                <button class="btn" style="color:white;background-color:rgb(252, 78, 36)" onclick="login('scatter');"><img src="res/wombat.svg" class="float-start" height="24">Wombat</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <header class="d-flex flex-wrap justify-content-center text-center py-3 mb-4 border-bottom border-light">
            <a href="https://neftygadgets.com/" target="_blank" class="navbar-brand me-auto text-light text-wrap" style="font-family:'Press Start 2P'">
                <h2>NEFTYGADGETS RACES</h2>
            </a>
            <ul class="nav nav-pills">
                <li class="nav-item" id="loginbtn"><a href="javascript:void(0)" class="nav-link active" aria-current="page" data-bs-toggle="modal" data-bs-target="#login">Login</a></li>
                <li class="nav-item dropdown visually-hidden" id="wallet">
                    <a class="nav-link dropdown-toggle text-light-emphasis" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">wallet</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="logout()">Logout</a></li>
                    </ul>
                </li>
            </ul>
        </header>
        <main>
            <div class="row mb-3">
                <div id="err_msg" class="alert alert-danger visually-hidden" role="alert"></div>
                <div id="pass_msg" class="alert alert-success visually-hidden" role="alert"></div>
                <div id="no_login" class="alert alert-warning text-center" role="alert">Please login first</div>
            </div>
            <div class="row">
                <div id="loading" class="d-flex justify-content-center mb-3 visually-hidden">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link text-light-emphasis active" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock-tab-pane" type="button" role="tab" aria-controls="stock-tab-pane" aria-selected="true">Stock</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link text-light-emphasis" id="super_stock-tab" data-bs-toggle="tab" data-bs-target="#super_stock-tab-pane" type="button" role="tab" aria-controls="super_stock-tab-pane" aria-selected="false">Super Stock</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link text-light-emphasis" id="masters-tab" data-bs-toggle="tab" data-bs-target="#masters-tab-pane" type="button" role="tab" aria-controls="masters-tab-pane" aria-selected="false">Masters</button>
                </li>
            </ul>
            <div class="tab-content visually-hidden" id="nft_tabcontent">
                <div class="tab-pane fade show active" id="stock-tab-pane" role="tabpanel" aria-labelledby="stock-tab" tabindex="0">
                    <div class="row mt-3 d-flex justify-content-center text-center" id="stock"></div>
                </div>
                <div class="tab-pane fade" id="super_stock-tab-pane" role="tabpanel" aria-labelledby="super_stock-tab" tabindex="0">
                    <div class="row mt-3 d-flex justify-content-center text-center" id="superstock"></div>
                </div>
                <div class="tab-pane fade" id="masters-tab-pane" role="tabpanel" aria-labelledby="masters-tab" tabindex="0">
                    <div class="row mt-3 d-flex justify-content-center text-center" id="masters"></div>
                </div>
            </div>
        </main>
        <footer class="mt-3">
            <div class="row justify-content-center border-top border-light">
                <p class="text-center my-3">Made by ryucrypt: wwiem.wam</p>
            </div>
        </footer>
    </div>
<script id="tmplt_asset" type="x-tmpl-mustache">
    <div class="col-6 col-md-4 col-lg-3 col-xl-2 gy-3">
        <div class="card">
            <p class="card-header">#{{mint}}</p>
            <div class="card-body">
                <div class="mx-1 my-1"><img class="img-fluid nft-card" style="object-fit:contain;height:10rem;width:10rem" src="{{#url}}{{/url}}"></div>
                <p class="card-text text-truncate">{{name}}</p>
                <a {{#id}}id="{{id}}"{{/id}} href="#" class="btn btn-primary text-uppercase {{division}}" style="width:100%" onclick="{{action}}">{{action_text}}</a>
            </div>
        </div>
    </div>
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/4.1.0/mustache.min.js" integrity="sha512-HYiNpwSxYuji84SQbCU5m9kHEsRqwWypXgJMBtbRSumlx1iBB6QaxgEBZHSHEGM+fKyCX/3Kb5V5jeVXm0OglQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://unpkg.com/anchor-link@3"></script>
<script src="https://unpkg.com/anchor-link-browser-transport@3"></script>
<script src="js/waxjs.js"></script>
<script src="js/scatterjs-core-min.js"></script>
<script src="js/scatterjs-plugin-eosjs.min.js"></script>
<script src="js/eos-min.js"></script>
<script src="js/wallets.js"></script>
<script>
const DIVISIONS = ["stock", "superstock", "masters"];
const EXPLORER = "https://testnet.waxblock.io/transaction/";
//const EXPLORER = "https://waxblock.io/transaction/";
const AH = "https://atomic-wax-test.tacocrypto.io/atomicassets/v1/assets?collection_name=neftygadgets,woodydragonz&owner={0}&page={1}&limit=100&order=desc&sort=asset_id";
const ASSETS = "https://atomic-wax-test.tacocrypto.io/atomicassets/v1/assets?ids=";
//const AH = "https://aa.neftyblocks.com/atomicassets/v1/assets?collection_name=neftygadgets&schema_name=machines&owner={0}&page={1}&limit=100&order=desc&sort=asset_id";
//const ASSETS = "https://aa.neftyblocks.com/atomicassets/v1/assets?ids=";
const IPFS = "https://ipfs.hivebp.io/ipfs/";
const CONTRACT = "neftyracersx";
var CONFIG = {
    "code": CONTRACT,
    "scope": "",
    "table": "config",
    "lower_bound": "",
    "upper_bound": "",
    "index_position": 1,
    "limit": 1000,
    "reverse": false,
    "json": true,
    "show_payer": false
};
var STAKED = {
    "code": CONTRACT,
    "scope": "",
    "table": "stakes",
    "lower_bound": "",
    "upper_bound": "",
    "index_position": 1,
    "limit": 1000,
    "reverse": false,
    "json": true,
    "show_payer": false
};
var wallet = "";
var perms = "";
var loggedin = false;
var config = {};
var assets = [];
var countdown_items = [];
var job_id;

String.prototype.format = function () {
    var args = arguments;
    return this.replace(/{([0-9]+)}/g, function (match, index) {
        return typeof args[index] == 'undefined' ? match : args[index];
    });
};

const formatTime = (delta) => {
    const hours = String(Math.floor(delta / 3600)).padStart(2, "0");
    const minutes = String(Math.floor((delta % 3600) / 60)).padStart(2, "0");
    const sec = String(delta % 60).padStart(2, "0");

    return `${hours}:${minutes}:${sec}`;
}

const countdown = (target) => {
    return target - Math.floor(Date.now() / 1000);
}

const fetchAssets = async() => {
    let page = 1;
    assets = [];
    while (true) {
        let r = await fetch(AH.format(wallet, page));
        var response = await r.json();
        if (response.data.length < 1) {
            break;
        }
        for (const i of response.data) {
            let division = config[parseInt(i.template.template_id)];
            if (division != undefined) {
                assets.push({
                    "asset_id": parseInt(i.asset_id),
                    "staked": false,
                    "division": division,
                    "name": i.name,
                    "mint": i.template_mint,
                    "img": i.data.img,
                    "url": function() {
                        return function() {
                            if (this.img.startsWith("http")) {
                                return this.img;
                            } else {
                                return IPFS + this.img;
                            }
                        }
                    },
                    "action": `stake(${i.asset_id},'${division}')`,
                    "action_text": "stake"
                });
            }
        }
        page++;
    }
}

const fetchStaked = async() => {
    countdown_items = [];
    for (const division of DIVISIONS) {
        STAKED.scope = division;
        STAKED.lower_bound = wallet;
        STAKED.upper_bound = wallet;

        var data = await wax.rpc.get_table_rows(STAKED);
        for (const i of data.rows) {
            let r = await fetch(ASSETS + i.asset);
            var response = await r.json();
            assets.unshift({
                "asset_id": parseInt(i.asset),
                "staked": true,
                "division": division,
                "name": response.data[0].name,
                "mint": response.data[0].template_mint,
                "img": response.data[0].data.img,
                "url": function() {
                    return function() {
                        if (this.img.startsWith("http")) {
                            return this.img;
                        } else {
                            return IPFS + this.img;
                        }
                    }
                },
                "action": `unstake('${division}')`,
                "action_text": "unstake",
                "id": `staked-${division}`
            });
            countdown_items.push({
                "id": `#staked-${division}`,
                "unlock": i.unlock,
                "done": false
            });
        }
    }
}

const setErr = (msg) => {
    $("#err_msg").text(msg);
    $("#err_msg").removeClass("visually-hidden");
}

const setPass = (msg) => {
    $("#pass_msg").html(msg);
    $("#pass_msg").removeClass("visually-hidden");
}

const loading = (start) => {
    if (start) {
        $("#loading").removeClass("visually-hidden");
        $("#nft_tabcontent").addClass("visually-hidden");
    } else {
        $("#loading").addClass("visually-hidden");
        $("#nft_tabcontent").removeClass("visually-hidden");
    }
}

const updateCountdown = () => {
    var filtered = countdown_items.filter(obj => obj.done == false);
    filtered.forEach((item) => {
        let delta = countdown(item.unlock);
        $(item.id).text(formatTime(delta));

        if (delta <= 0) {
            $(item.id).text("unstake");
            $(item.id).removeClass("disabled");
            item.done = true;
        }
    });
    if (filtered.length < 1 && job_id != null) {
        clearInterval(job_id);
        job_id = null;
    }
}

const refresh = () => {
    var template = $("#tmplt_asset").html();

    for (const division of DIVISIONS) {
        var filtered = assets.filter(obj => obj.division == division);
        $(`#${division}`).empty();

        if (filtered.length < 1) {
            $(`#${division}`).text("No assets!");
        } else {
            for (const item of filtered) {
                let rendered = $(Mustache.render(template, item));
                rendered.appendTo(`#${division}`);
            }
            if (filtered.filter(obj => obj.staked == true).length > 0) {
                $(`.btn.${division}`).each(function() {
                    $(this).addClass("disabled");
                    $(this).text("lineup full");
                });
            }
        }
    }
    if (job_id != null) {
        clearInterval(job_id);
        job_id = null;
    }
    job_id = setInterval(updateCountdown, 1000);
}

const logout = async() => {
    await wallet_logout();
    $("#loginbtn").toggleClass("visually-hidden");
    $("#wallet").toggleClass("visually-hidden");
    $("#err_msg").addClass("visually-hidden");
    $("#pass_msg").addClass("visually-hidden");
    $("#no_login").removeClass("visually-hidden");
    loggedin = false;

    $("#nft_tabcontent").addClass("visually-hidden");
    assets = [];
    countdown_items = [];
    refresh();
}

const login = async(walletType) => {
    if (walletType) {
        wallet_selectWallet(walletType);
    }

    try {
        $("#login_msg").addClass("visually-hidden");
        wallet = await wallet_login();
        perms = wallet.split("@")[1];
        wallet = wallet.split("@")[0];
        $("#wallet a:first").text(wallet);
        $("#loginbtn").addClass("visually-hidden");
        $("#wallet").removeClass("visually-hidden");
        $("#no_login").addClass("visually-hidden");
        bootstrap.Modal.getOrCreateInstance("#login").hide();
        loggedin = true;
        loading(true);
        await fetchAssets();
        await fetchStaked();
        refresh();
        loading(false);
    } catch(e) {
        $("#login_msg").removeClass("visually-hidden");
        $("#login_msg").text(e.message);
    }
}

const stake = async(asset_id, division) => {
    $("#err_msg").addClass("visually-hidden");
    $("#pass_msg").addClass("visually-hidden");

    if (!loggedin) {
        setErr("Please login first");
        return;
    }

    try {
        var actions = [{
            account: "atomicassets",
            name: "transfer",
            authorization: [{
                actor: wallet,
                permission: perms,
            }],
            data: {
                from: wallet,
                to: CONTRACT,
                asset_ids: [asset_id],
                memo: division
            }
        }];
        var txn = await wallet_transact(actions);
        setPass("Success! <a href='{0}{1}' target='_blank'>View Transaction</a>".format(EXPLORER, txn.transaction_id));
        setTimeout(async() => {
            loading(true);
            await fetchAssets();
            await fetchStaked();
            refresh();
            loading(false);
        }, 1500);
    } catch(e) {
        setErr(e.message);
    }
}

const unstake = async(division) => {
    $("#err_msg").addClass("visually-hidden");
    $("#pass_msg").addClass("visually-hidden");

    if (!loggedin) {
        setErr("Please login first");
        return;
    }

    try {
        var actions = [{
            account: CONTRACT,
            name: "unstake",
            authorization: [{
                actor: wallet,
                permission: perms,
            }],
            data: {
                player: wallet,
                division: division
            }
        }];
        var txn = await wallet_transact(actions);
        setPass("Success! <a href='{0}{1}' target='_blank'>View Transaction</a>".format(EXPLORER, txn.transaction_id));
        setTimeout(async() => {
            loading(true);
            await fetchAssets();
            await fetchStaked();
            refresh();
            loading(false);
        }, 1500);
    } catch(e) {
        setErr(e.message);
    }
}

$(document).ready(async function() {
    for (const division of DIVISIONS) {
        CONFIG.scope = division;
        data = await wax.rpc.get_table_rows(CONFIG);
        for (let i = 0; i < data.rows.length; i++) {
            var row = data.rows[i];
            config[row.template_id] = division;
        }
    }
    if (await wallet_isAutoLoginAvailable()) {
        await login();
    }
});
</script>
</body>
</html>